@page "/monthly-stats"
@attribute [StreamRendering]
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject IConfiguration Configuration

<PageTitle>Monthly Weather Statistics</PageTitle>

<button class="mode-toggle" onclick="toggleDarkMode()">
    <img src="images/contrast.png" alt="Toggle Theme" />
</button>

<h2 class="text-center text-2xl font-bold mt-6">ðŸ“Š Monthly Weather Statistics</h2>

<div class="trend-container">
    <div class="trend-input-group">
        <input @bind="city" placeholder="Enter City" class="trend-input" />
        <select @bind="selectedMonth" class="trend-date">
            @foreach (var month in months)
            {
                <option value="@month.Value">@month.Key</option>
            }
        </select>
        <button class="trend-button" @onclick="FetchMonthlyStats">Analyze</button>
    </div>

    @if (isLoading)
    {
        <p class="loading-text">Loading data...</p>
    }

    @if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <p class="error-text">@errorMessage</p>
    }

    <div class="trend-chart-container">
        <canvas id="monthlyChart" width="800" height="400" class="mt-4"></canvas>
    </div>
</div>

<style>
/* ðŸŒ™ Dark Mode Styles */
.dark-mode .trend-container {
    background-color: #1e1e1e;
    color: #e0e0e0;
    box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
}

.dark-mode .trend-input,
.dark-mode .trend-date {
    background-color: #2d2d2d;
    color: #e0e0e0;
    border: 1px solid #444;
}

.dark-mode .trend-input:focus,
.dark-mode .trend-date:focus {
    border-color: #ff8800;
    box-shadow: 0 0 0 2px rgba(255, 136, 0, 0.3);
}

.dark-mode .trend-button {
    background: linear-gradient(90deg, #ff6a00, #ee0979);
    color: white;
}

.dark-mode .loading-text {
    color: #ccc;
}

.dark-mode .error-text {
    color: #ff6b6b;
}

.dark-mode .trend-heading {
    color: #f0f0f0;
}

/* ðŸ“Š Make Chart Text White in Dark Mode */
.dark-mode #monthlyChart {
    background-color: transparent;
}

/* ðŸŒ˜ Chart.js axis/grid color override (optional if using Chart.js dark theme settings) */
.dark-mode .chartjs-render-monitor {
    color: #e0e0e0 !important;
}

/* ðŸŒ“ Theme Toggle Button Styling */
.theme-toggle {
    position: fixed;
    top: 80px;
    right: 90px;
    border: 0;
    outline: 0;
    background: #f4f4f4;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    transition: background-color 0.3s ease;
}

.theme-toggle img {
    width: 24px;
}

/* Adjust in dark mode */
.dark-mode .theme-toggle {
    background-color: #444;
}
</style>


@code {
    private string city = "Delhi";
    private string selectedMonth = DateTime.Now.Month.ToString("00");
    private bool isLoading = false;
    private string errorMessage = "";
    private List<DailyStat> monthlyStats = new();

    private Dictionary<string, string> months = new()
    {
        { "January", "01" }, { "February", "02" }, { "March", "03" },
        { "April", "04" }, { "May", "05" }, { "June", "06" },
        { "July", "07" }, { "August", "08" }, { "September", "09" },
        { "October", "10" }, { "November", "11" }, { "December", "12" },
    };

    private async Task FetchMonthlyStats()
    {
        errorMessage = "";
        isLoading = true;

        try
        {
            monthlyStats = await GetMonthlyDataAsync(city, selectedMonth);
            await JS.InvokeVoidAsync("plotMonthlyWeatherStats", city, monthlyStats);
        }
        catch (Exception ex)
        {
            errorMessage = "Something went wrong while fetching statistics.";
            Console.WriteLine(ex);
        }

        isLoading = false;
    }

    private async Task<(double lat, double lon)> GetCoordinatesAsync(string city)
    {
        var apiKey = Configuration["WeatherApi:Key"];
        var url = $"https://api.openweathermap.org/geo/1.0/direct?q={city}&limit=1&appid={apiKey}";
        var http = new HttpClient();
        var result = await http.GetFromJsonAsync<List<GeoResult>>(url);
        var location = result?.FirstOrDefault();
        if (location == null) throw new Exception("City not found.");
        return (location.Lat, location.Lon);
    }

    private async Task<List<DailyStat>> GetMonthlyDataAsync(string city, string month)
    {
        var apiKey = Configuration["WeatherApi:Key"];
        var (lat, lon) = await GetCoordinatesAsync(city);
        var url = $"https://api.openweathermap.org/data/2.5/forecast?lat={lat}&lon={lon}&appid={apiKey}&units=metric";

        var http = new HttpClient();
        var forecast = await http.GetFromJsonAsync<ForecastResponse>(url);
        if (forecast == null || forecast.List.Count == 0) throw new Exception("No forecast data found.");

        var stats = forecast.List
            .Where(f => DateTime.Parse(f.Dt_txt).ToString("MM") == month)
            .GroupBy(f => DateTime.Parse(f.Dt_txt).Date)
            .Select(g => new DailyStat
            {
                Date = g.Key.ToString("yyyy-MM-dd"),
                AvgTemp = Math.Round(g.Average(x => x.Main.Temp), 2),
                AvgHumidity = Math.Round(g.Average(x => x.Main.Humidity), 2),
                TotalRain = Math.Round(g.Sum(x => x.Rain?.ThreeH ?? 0), 2)
            })
            .ToList();

        return stats;
    }

    public class GeoResult
    {
        public double Lat { get; set; }
        public double Lon { get; set; }
    }

    public class ForecastResponse
    {
        public List<ForecastItem> List { get; set; } = new();
    }

    public class ForecastItem
    {
        public MainInfo Main { get; set; } = new();
        public RainInfo Rain { get; set; }
        public string Dt_txt { get; set; }
    }

    public class MainInfo
    {
        public double Temp { get; set; }
        public double Humidity { get; set; }
    }

    public class RainInfo
    {
        [System.Text.Json.Serialization.JsonPropertyName("3h")]
        public double ThreeH { get; set; }
    }

    public class DailyStat
    {
        public string Date { get; set; }
        public double AvgTemp { get; set; }
        public double AvgHumidity { get; set; }
        public double TotalRain { get; set; }
    }
}


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let monthlyChartInstance = null;

    async function plotMonthlyWeatherStats(city, data) {
        const ctx = document.getElementById("monthlyChart").getContext("2d");

        // Destroy old chart if it exists
        if (monthlyChartInstance) {
            monthlyChartInstance.destroy();
        }

        // Extract data
        const labels = data.map(d => d.date);
        const temperatures = data.map(d => d.avgTemp);
        const humidity = data.map(d => d.avgHumidity);
        const rainfall = data.map(d => d.totalRain);

        monthlyChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Avg Temperature (Â°C)',
                        data: temperatures,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.3)',
                        yAxisID: 'y',
                        type: 'line',
                        tension: 0.4
                    },
                    {
                        label: 'Avg Humidity (%)',
                        data: humidity,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.3)',
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Total Rainfall (mm)',
                        data: rainfall,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.4)',
                        yAxisID: 'y2'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                stacked: false,
                plugins: {
                    title: {
                        display: true,
                        text: `ðŸ“Š Monthly Weather Stats for ${city}`
                    },
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Temperature (Â°C)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Humidity (%)'
                        }
                    },
                    y2: {
                        type: 'linear',
                        position: 'right',
                        offset: true,
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Rainfall (mm)'
                        }
                    }
                }
            }
        });
    }

function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('mode', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    // Apply saved mode on load
    window.onload = () => {
        if (localStorage.getItem('mode') === 'dark') {
            document.body.classList.add('dark-mode');
        }
    };

</script>